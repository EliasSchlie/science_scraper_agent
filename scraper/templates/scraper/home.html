{% extends "scraper/base.html" %}

{% block title %}Scraper - Interaction Scraper{% endblock %}

{% block extra_style %}
.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}
.stat-card {
  background: #2d2d2d;
  border: 1px solid #404040;
  border-radius: 6px;
  padding: 16px;
  text-align: center;
}
.stat-value {
  font-size: 28px;
  font-weight: 600;
  color: #5865f2;
  margin-bottom: 4px;
}
.stat-label {
  font-size: 12px;
  color: #b9bbbe;
}
.card {
  background: #2d2d2d;
  border: 1px solid #404040;
  border-radius: 6px;
  padding: 20px;
  margin-bottom: 16px;
}
h2 {
  margin-bottom: 16px;
  font-size: 16px;
  color: #ffffff;
  font-weight: 500;
}
.form-group { margin-bottom: 14px; }
label {
  display: block;
  margin-bottom: 6px;
  font-size: 13px;
  color: #b9bbbe;
}
input, select {
  width: 100%;
  background: #1e1e1e;
  border: 1px solid #404040;
  color: #dcddde;
  padding: 8px 12px;
  border-radius: 4px;
  font-size: 13px;
}
input:focus, select:focus {
  outline: none;
  border-color: #5865f2;
}
button {
  background: #5865f2;
  border: none;
  color: #fff;
  padding: 10px 20px;
  border-radius: 4px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
}
button:hover { background: #4752c4; }
button:disabled {
  background: #404040;
  cursor: not-allowed;
}
.job-list { list-style: none; }
.job-item {
  background: #1e1e1e;
  border: 1px solid #404040;
  border-radius: 4px;
  padding: 12px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
}
.job-info { flex: 1; }
.job-title {
  font-weight: 500;
  font-size: 14px;
  margin-bottom: 4px;
}
.job-meta {
  font-size: 12px;
  color: #888;
}
.job-status {
  padding: 4px 10px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 500;
  white-space: nowrap;
}
.status-pending { background: #f0b132; color: #000; }
.status-running { background: #5865f2; color: #fff; }
.status-completed { background: #43b581; color: #fff; }
.status-failed { background: #f04747; color: #fff; }
.job-actions {
  display: flex;
  gap: 6px;
}
.btn-small {
  padding: 5px 10px;
  font-size: 12px;
  background: #404040;
}
.btn-small:hover { background: #4a4a4a; }
.btn-danger { background: #f04747; }
.btn-danger:hover { background: #d84040; }
.error, .success {
  padding: 10px;
  border-radius: 4px;
  margin-bottom: 14px;
  font-size: 13px;
}
.error { background: #f04747; color: #fff; }
.success { background: #43b581; color: #fff; }
.empty-state {
  text-align: center;
  padding: 30px;
  color: #888;
  font-size: 13px;
}
{% endblock %}

{% block content %}
<div class="container">

  <div class="stats">
    <div class="stat-card">
      <div class="stat-value">{{ total_interactions }}</div>
      <div class="stat-label">Total Interactions</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ recent_jobs|length }}</div>
      <div class="stat-label">Recent Jobs</div>
    </div>
  </div>

  <div id="message-container"></div>

  <div class="card">
    <h2>Start New Scraper Job</h2>
    <form id="start-job-form">
      <div class="form-group">
        <label for="variable">Variable of Interest</label>
        <input type="text" id="variable" placeholder="e.g., creatine, caffeine, omega-3" required>
      </div>
      <div class="form-group">
        <label for="min-interactions">Minimum Interactions (1 credit each)</label>
        <input type="number" id="min-interactions" value="5" min="1" required oninput="updateCost()">
      </div>
      <button type="submit" id="start-btn">Start Scraper (5 credits)</button>
    </form>
  </div>

  <div class="card">
    <h2>Recent Jobs</h2>
    {% if recent_jobs %}
      <ul class="job-list" id="job-list">
        {% for job in recent_jobs %}
        <li class="job-item" data-job-id="{{ job.id }}">
          <div class="job-info">
            <div class="job-title">{{ job.variable_of_interest }}</div>
            <div class="job-meta">
              {{ job.interactions_found }} interactions Â· {{ job.papers_checked }} papers
            </div>
          </div>
          <span class="job-status status-{{ job.status }}">{{ job.status }}</span>
          <div class="job-actions">
            {% if job.status == 'running' %}
              <button class="btn-small" onclick="stopJob({{ job.id }})">Stop</button>
            {% endif %}
            <button class="btn-small" onclick="viewJob({{ job.id }})">View</button>
            <button class="btn-small btn-danger" onclick="deleteJob({{ job.id }})">Delete</button>
          </div>
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="empty-state">No jobs yet. Start a new job above!</div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_script %}
let pollingInterval = null;

function updateCost() {
  const minInteractions = parseInt(document.getElementById('min-interactions').value) || 5;
  const btn = document.getElementById('start-btn');
  btn.textContent = `Start Scraper (${minInteractions} credits)`;
}

document.getElementById('start-job-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const variable = document.getElementById('variable').value.trim();
  const minInteractions = parseInt(document.getElementById('min-interactions').value);

  if (!variable) return;

  try {
    const response = await fetch('/scraper/api/start/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        variable_of_interest: variable,
        min_interactions: minInteractions
      })
    });

    const data = await response.json();

    if (response.ok) {
      showMessage(data.message || 'Job started successfully!', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      if (data.insufficient_credits) {
        showMessage(data.error + ' Visit your account page to view credits.', 'error');
      } else {
        showMessage(data.error, 'error');
      }
    }
  } catch (error) {
    showMessage('Error: ' + error.message, 'error');
  }
});

async function stopJob(jobId) {
  try {
    const response = await fetch(`/scraper/api/job/${jobId}/stop/`, { method: 'POST' });
    const data = await response.json();
    showMessage(data.message || data.error, response.ok ? 'success' : 'error');
    if (response.ok) setTimeout(() => location.reload(), 1000);
  } catch (error) {
    showMessage('Error: ' + error.message, 'error');
  }
}

async function deleteJob(jobId) {
  if (!confirm('Delete this job and its interactions?')) return;

  try {
    const response = await fetch(`/scraper/api/job/${jobId}/delete/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    const data = await response.json();

    if (response.ok) {
      showMessage('Job deleted', 'success');
      setTimeout(() => location.reload(), 500);
    } else if (data.can_force) {
      if (confirm(data.error + ' Force delete?')) {
        const forceResponse = await fetch(`/scraper/api/job/${jobId}/delete/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ force: true })
        });
        if (forceResponse.ok) {
          showMessage('Job force deleted', 'success');
          setTimeout(() => location.reload(), 500);
        }
      }
    } else {
      showMessage(data.error, 'error');
    }
  } catch (error) {
    showMessage('Error: ' + error.message, 'error');
  }
}

function viewJob(jobId) {
  window.open(`/scraper/api/job/${jobId}/status/`, '_blank');
}

function showMessage(msg, type) {
  const container = document.getElementById('message-container');
  container.innerHTML = `<div class="${type}">${msg}</div>`;
  setTimeout(() => container.innerHTML = '', 5000);
}

// Poll for updates on running jobs
async function pollJobs() {
  const runningJobs = document.querySelectorAll('.status-running');
  if (runningJobs.length === 0) return;

  runningJobs.forEach(async (statusEl) => {
    const jobItem = statusEl.closest('.job-item');
    const jobId = jobItem.dataset.jobId;

    try {
      const response = await fetch(`/scraper/api/job/${jobId}/status/`);
      const data = await response.json();

      if (data.status !== 'running') {
        location.reload();
      }
    } catch (error) {
      console.error('Poll error:', error);
    }
  });
}

// Start polling if there are running jobs
if (document.querySelectorAll('.status-running').length > 0) {
  pollingInterval = setInterval(pollJobs, 3000);
}
{% endblock %}
