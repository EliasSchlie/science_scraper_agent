{% extends "scraper/base.html" %}

{% block title %}ü§ñ Scraper{% endblock %}

{% block extra_style %}
.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card {
  background: linear-gradient(135deg, #141414 0%, #0a0a0a 100%);
  border: 1px solid #2a2a2a;
  border-radius: 12px;
  padding: 24px;
  text-align: center;
  transition: all 0.3s;
}

.stat-card:hover {
  border-color: #3a3a3a;
  transform: translateY(-2px);
}

.stat-value {
  font-size: 36px;
  font-weight: 700;
  color: #6366f1;
  margin-bottom: 8px;
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stat-label {
  font-size: 13px;
  color: #808080;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.card {
  background: #0f0f0f;
  border: 1px solid #2a2a2a;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 20px;
}

h2 {
  margin-bottom: 20px;
  font-size: 18px;
  color: #ffffff;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
}

.form-group {
  margin-bottom: 18px;
}

label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  color: #b0b0b0;
  font-weight: 500;
}

input, select {
  width: 100%;
  background: #141414;
  border: 1px solid #2a2a2a;
  color: #e0e0e0;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 14px;
  transition: all 0.2s;
}

input:focus, select:focus {
  outline: none;
  border-color: #6366f1;
  background: #1a1a1a;
}

button {
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
  border: none;
  color: #fff;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
}

button:disabled {
  background: #1a1a1a;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.job-list {
  list-style: none;
}

.job-item {
  background: #141414;
  border: 1px solid #2a2a2a;
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 16px;
  transition: all 0.2s;
}

.job-item:hover {
  border-color: #3a3a3a;
  background: #1a1a1a;
}

.job-info {
  flex: 1;
}

.job-title {
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 6px;
  color: #ffffff;
}

.job-meta {
  font-size: 13px;
  color: #808080;
}

.job-status {
  padding: 6px 14px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.status-pending {
  background: rgba(251, 191, 36, 0.15);
  color: #fbbf24;
  border: 1px solid rgba(251, 191, 36, 0.3);
}

.status-running {
  background: rgba(99, 102, 241, 0.15);
  color: #6366f1;
  border: 1px solid rgba(99, 102, 241, 0.3);
}

.status-completed {
  background: rgba(34, 197, 94, 0.15);
  color: #22c55e;
  border: 1px solid rgba(34, 197, 94, 0.3);
}

.status-failed {
  background: rgba(239, 68, 68, 0.15);
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.3);
}

.job-actions {
  display: flex;
  gap: 8px;
}

.btn-small {
  padding: 8px 14px;
  font-size: 12px;
  background: #1a1a1a;
  border: 1px solid #2a2a2a;
  font-weight: 500;
}

.btn-small:hover {
  background: #242424;
  border-color: #3a3a3a;
}

.btn-danger {
  background: rgba(239, 68, 68, 0.15);
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.3);
}

.btn-danger:hover {
  background: rgba(239, 68, 68, 0.25);
}

.error, .success {
  padding: 14px 18px;
  border-radius: 10px;
  margin-bottom: 18px;
  font-size: 14px;
  font-weight: 500;
}

.error {
  background: rgba(239, 68, 68, 0.15);
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.3);
}

.success {
  background: rgba(34, 197, 94, 0.15);
  color: #22c55e;
  border: 1px solid rgba(34, 197, 94, 0.3);
}

.empty-state {
  text-align: center;
  padding: 40px;
  color: #606060;
  font-size: 14px;
}

.job-activity {
  margin-top: 8px;
  font-size: 12px;
  color: #6366f1;
  font-style: italic;
  opacity: 0.8;
}
{% endblock %}

{% block content %}
<div class="container">

  <div class="stats">
    <div class="stat-card">
      <div class="stat-value">{{ total_interactions }}</div>
      <div class="stat-label">üìà Total Interactions</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ recent_jobs|length }}</div>
      <div class="stat-label">‚ö° Recent Jobs</div>
    </div>
  </div>

  <div id="message-container"></div>

  <div class="card">
    <h2>üöÄ Start New Scraper Job</h2>
    <form id="start-job-form">
      <div class="form-group">
        <label for="variable">üî¨ Variable of Interest</label>
        <input type="text" id="variable" placeholder="e.g., creatine, caffeine, omega-3" required>
      </div>
      <div class="form-group">
        <label for="min-interactions">Minimum Interactions (1 credit each)</label>
        <input type="number" id="min-interactions" value="5" min="1" required oninput="updateCost()">
      </div>
      <button type="submit" id="start-btn">Start Scraper (5 credits)</button>
    </form>
  </div>

  <div class="card">
    <h2>üìã Recent Jobs</h2>
    {% if recent_jobs %}
      <ul class="job-list" id="job-list">
        {% for job in recent_jobs %}
        <li class="job-item" data-job-id="{{ job.id }}">
          <div class="job-info">
            <div class="job-title">{{ job.variable_of_interest }}</div>
            <div class="job-meta">
              {{ job.interactions_found }} interactions ¬∑ {{ job.papers_checked }} papers
            </div>
            {% if job.status == 'running' %}
            <div class="job-activity" data-job-id="{{ job.id }}">Creating queries...</div>
            {% endif %}
          </div>
          <span class="job-status status-{{ job.status }}">{{ job.status }}</span>
          <div class="job-actions">
            {% if job.status == 'running' %}
              <button class="btn-small" onclick="stopJob({{ job.id }})">‚è∏Ô∏è Stop</button>
            {% endif %}
            <button class="btn-small btn-danger" onclick="deleteJob({{ job.id }})">üóëÔ∏è</button>
          </div>
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="empty-state">No jobs yet. Start a new job above! üéØ</div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_script %}
let pollingInterval = null;

function updateCost() {
  const minInteractions = parseInt(document.getElementById('min-interactions').value) || 5;
  const btn = document.getElementById('start-btn');
  btn.textContent = `Start Scraper (${minInteractions} credits)`;
}

document.getElementById('start-job-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const variable = document.getElementById('variable').value.trim();
  const minInteractions = parseInt(document.getElementById('min-interactions').value);

  if (!variable) return;

  try {
    const response = await fetch('/scraper/api/start/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        variable_of_interest: variable,
        min_interactions: minInteractions
      })
    });

    const data = await response.json();

    if (response.ok) {
      showMessage(data.message || 'Job started successfully! ‚ú®', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      if (data.insufficient_credits) {
        showMessage(data.error + ' Visit your account page to view credits.', 'error');
      } else {
        showMessage(data.error, 'error');
      }
    }
  } catch (error) {
    showMessage('Error: ' + error.message, 'error');
  }
});

async function stopJob(jobId) {
  try {
    const response = await fetch(`/scraper/api/job/${jobId}/stop/`, { method: 'POST' });
    const data = await response.json();
    showMessage(data.message || data.error, response.ok ? 'success' : 'error');
    if (response.ok) setTimeout(() => location.reload(), 1000);
  } catch (error) {
    showMessage('Error: ' + error.message, 'error');
  }
}

async function deleteJob(jobId) {
  if (!confirm('Delete this job and its interactions?')) return;

  try {
    const response = await fetch(`/scraper/api/job/${jobId}/delete/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    const data = await response.json();

    if (response.ok) {
      showMessage('Job deleted ‚úì', 'success');
      setTimeout(() => location.reload(), 500);
    } else if (data.can_force) {
      if (confirm(data.error + ' Force delete?')) {
        const forceResponse = await fetch(`/scraper/api/job/${jobId}/delete/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ force: true })
        });
        if (forceResponse.ok) {
          showMessage('Job force deleted ‚úì', 'success');
          setTimeout(() => location.reload(), 500);
        }
      }
    } else {
      showMessage(data.error, 'error');
    }
  } catch (error) {
    showMessage('Error: ' + error.message, 'error');
  }
}

function showMessage(msg, type) {
  const container = document.getElementById('message-container');
  container.innerHTML = `<div class="${type}">${msg}</div>`;
  setTimeout(() => container.innerHTML = '', 5000);
}

// Poll for updates on running jobs
async function pollJobs() {
  const runningJobs = document.querySelectorAll('.status-running');
  if (runningJobs.length === 0) return;

  runningJobs.forEach(async (statusEl) => {
    const jobItem = statusEl.closest('.job-item');
    const jobId = jobItem.dataset.jobId;

    try {
      const response = await fetch(`/scraper/api/job/${jobId}/status/`);
      const data = await response.json();

      if (data.status !== 'running') {
        location.reload();
      }
    } catch (error) {
      console.error('Poll error:', error);
    }
  });
}

// Rotate activity messages for running jobs
const activityMessages = [
  "Creating queries...",
  "Searching PubMed...",
  "Reading papers...",
  "Extracting interactions..."
];

function rotateActivityMessages() {
  const activityElements = document.querySelectorAll('.job-activity');
  activityElements.forEach((el) => {
    const randomMessage = activityMessages[Math.floor(Math.random() * activityMessages.length)];
    el.textContent = randomMessage;
  });
}

// Start polling if there are running jobs
if (document.querySelectorAll('.status-running').length > 0) {
  pollingInterval = setInterval(pollJobs, 3000);
  // Rotate activity messages every 2-5 seconds randomly
  setInterval(() => {
    rotateActivityMessages();
  }, Math.random() * 3000 + 2000);
}
{% endblock %}
