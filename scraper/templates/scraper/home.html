<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scientific Paper Scraper Agent</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, sans-serif;
        background: #0a0a0a;
        min-height: 100vh;
        padding: 20px;
        color: #e0e0e0;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        color: #ffffff;
        margin-bottom: 40px;
      }

      header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 300;
        letter-spacing: -0.5px;
      }

      header p {
        font-size: 1em;
        opacity: 0.6;
        font-weight: 300;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      @media (max-width: 1024px) {
        .main-grid {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: #1a1a1a;
        border-radius: 8px;
        padding: 30px;
        border: 1px solid #2a2a2a;
      }

      .card h2 {
        margin-bottom: 20px;
        color: #ffffff;
        font-size: 1.5em;
        font-weight: 400;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 400;
        color: #b0b0b0;
        font-size: 0.9em;
      }

      .form-group input {
        width: 100%;
        padding: 12px;
        border: 1px solid #2a2a2a;
        border-radius: 6px;
        font-size: 16px;
        background: #0a0a0a;
        color: #ffffff;
        transition: border-color 0.3s;
      }

      .form-group input:focus {
        outline: none;
        border-color: #4a4a4a;
      }

      .btn {
        background: #ffffff;
        color: #0a0a0a;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        width: 100%;
      }

      .btn:hover {
        background: #e0e0e0;
      }

      .btn:active {
        background: #d0d0d0;
      }

      .btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-box {
        background: #1a1a1a;
        border: 1px solid #2a2a2a;
        color: #ffffff;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }

      .stat-box .number {
        font-size: 2.5em;
        font-weight: 300;
        margin-bottom: 5px;
      }

      .stat-box .label {
        font-size: 0.85em;
        opacity: 0.6;
        font-weight: 300;
      }

      .progress-container {
        background: #1a1a1a;
        border: 1px solid #2a2a2a;
        border-radius: 8px;
        padding: 30px;
        margin-bottom: 20px;
      }

      .progress-container h2 {
        color: #ffffff;
        margin-bottom: 20px;
        font-weight: 400;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: 500;
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-pending {
        background: rgba(253, 203, 110, 0.2);
        color: #fdcb6e;
        border: 1px solid rgba(253, 203, 110, 0.3);
      }
      .status-running {
        background: rgba(116, 185, 255, 0.2);
        color: #74b9ff;
        border: 1px solid rgba(116, 185, 255, 0.3);
      }
      .status-completed {
        background: rgba(0, 184, 148, 0.2);
        color: #00b894;
        border: 1px solid rgba(0, 184, 148, 0.3);
      }
      .status-failed {
        background: rgba(255, 118, 117, 0.2);
        color: #ff7675;
        border: 1px solid rgba(255, 118, 117, 0.3);
      }

      .step-log {
        background: #0a0a0a;
        color: #d4d4d4;
        border-radius: 6px;
        border: 1px solid #2a2a2a;
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
        font-size: 0.85em;
        line-height: 1.8;
        margin-top: 15px;
      }

      .step-log .step {
        padding: 3px 0;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      /* Syntax highlighting for logs */
      .step-log .step:has-text('✓') {
        color: #4ec9b0;
      }

      .step-log .step:has-text('✗') {
        color: #f48771;
      }

      .step-log .step:has-text('💾') {
        color: #dcdcaa;
      }

      .interactions-table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
      }

      .interactions-table th {
        background: #0a0a0a;
        color: #b0b0b0;
        padding: 12px;
        text-align: left;
        font-weight: 500;
        font-size: 0.85em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid #2a2a2a;
      }

      .interactions-table td {
        padding: 12px;
        border-bottom: 1px solid #2a2a2a;
      }

      .interactions-table tr:hover {
        background: rgba(255, 255, 255, 0.02);
      }

      .effect-positive {
        color: #00b894;
        font-weight: bold;
      }

      .effect-negative {
        color: #ff7675;
        font-weight: bold;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .empty-state svg {
        width: 100px;
        height: 100px;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .recent-jobs-scrollable {
        max-height: 400px;
        overflow-y: auto;
      }

      .recent-jobs-scrollable::-webkit-scrollbar {
        width: 8px;
      }

      .recent-jobs-scrollable::-webkit-scrollbar-track {
        background: #0a0a0a;
        border-radius: 4px;
      }

      .recent-jobs-scrollable::-webkit-scrollbar-thumb {
        background: #2a2a2a;
        border-radius: 4px;
      }

      .recent-jobs-scrollable::-webkit-scrollbar-thumb:hover {
        background: #3a3a3a;
      }

      .delete-job-btn {
        background: transparent;
        border: none;
        font-size: 1.2em;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 4px;
        transition: background 0.2s;
      }

      .delete-job-btn:hover {
        background: rgba(255, 118, 117, 0.15);
      }

      .job-item:hover {
        background: rgba(255, 255, 255, 0.02);
      }

      /* Navigation tabs */
      .nav-tabs {
        background: #0a0a0a;
        border-bottom: 1px solid #2a2a2a;
        padding: 0;
        display: flex;
        justify-content: center;
        margin: -20px -20px 0 -20px;
      }

      .nav-tabs a {
        color: #b0b0b0;
        text-decoration: none;
        padding: 15px 30px;
        display: inline-block;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
      }

      .nav-tabs a:hover {
        background: #1a1a1a;
        color: #e0e0e0;
      }

      .nav-tabs a.active {
        border-bottom-color: #ffffff;
        color: #ffffff;
      }

      /* Workspace selector */
      .workspace-selector {
        background: #0a0a0a;
        border-bottom: 1px solid #2a2a2a;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin: 0 -20px 30px -20px;
      }

      .workspace-selector label {
        color: #b0b0b0;
        font-size: 0.9em;
      }

      .workspace-selector select {
        background: #1a1a1a;
        border: 1px solid #2a2a2a;
        color: #ffffff;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
      }

      .workspace-selector select:focus {
        outline: none;
        border-color: #4a4a4a;
      }

      .workspace-selector input {
        background: #1a1a1a;
        border: 1px solid #2a2a2a;
        color: #ffffff;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        width: 150px;
      }

      .workspace-selector button {
        background: #ffffff;
        color: #0a0a0a;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }

      .workspace-selector button:hover {
        background: #e0e0e0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Navigation tabs -->
      <nav class="nav-tabs">
        <a href="/scraper/" class="active">Scraper</a>
        <a href="/scraper/graph/">Current Graph</a>
        <a href="http://interaction-scraper.eliasschlie.com/" target="_blank"
          >Example Graphs</a
        >
        <a
          href="https://youtu.be/dB3zxp_iKWc?si=FSnKdzKQsgGlozKh"
          target="_blank"
          >Video Walkthrough</a
        >
      </nav>

      <!-- Workspace selector -->
      <div class="workspace-selector">
        <label for="workspace-select">Workspace:</label>
        <select id="workspace-select" onchange="switchWorkspace()">
          {% for ws in all_workspaces %}
          <option value="{{ ws }}" {% if ws == current_workspace %}selected{% endif %}>{{ ws }}</option>
          {% endfor %}
        </select>
        <span style="color: #666;">|</span>
        <input type="text" id="new-workspace-name" placeholder="New workspace name" />
        <button onclick="createWorkspace()">Create New</button>
      </div>

      <header>
        <h1>🔬 Scientific Paper Scraper Agent</h1>
        <p>
          Automated extraction of causal interactions from scientific literature
        </p>
      </header>

      <div class="stats">
        <div class="stat-box">
          <div class="number" id="total-interactions">
            {{ total_interactions }}
          </div>
          <div class="label">Total Interactions</div>
        </div>
        <div class="stat-box">
          <div class="number" id="total-jobs">{{ recent_jobs|length }}</div>
          <div class="label">Recent Jobs</div>
        </div>
      </div>

      <div class="main-grid">
        <div class="card">
          <h2>🚀 Start New Search</h2>
          <form id="scraper-form">
            <div class="form-group">
              <label for="variable">Variable of Interest</label>
              <input
                type="text"
                id="variable"
                name="variable"
                placeholder="e.g., creatine, vitamin D, exercise"
                required
              />
            </div>
            <div class="form-group">
              <label for="min-interactions">Minimum Interactions</label>
              <input
                type="number"
                id="min-interactions"
                name="min-interactions"
                value="5"
                min="1"
                max="100"
              />
            </div>
            <button type="submit" class="btn" id="start-btn">
              Start Scraping
            </button>
          </form>
        </div>

        <div class="card">
          <h2>📊 Recent Jobs</h2>
          <div id="recent-jobs" class="recent-jobs-scrollable">
            {% if recent_jobs %} {% for job in recent_jobs %}
            <div
              class="job-item"
              style="
                padding: 10px;
                border-bottom: 1px solid #2a2a2a;
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <div
                style="flex: 1; cursor: pointer"
                onclick="loadJob({{ job.id }})"
              >
                <div style="font-weight: 500; color: #ffffff">
                  {{ job.variable_of_interest }}
                </div>
                <div style="font-size: 0.9em; color: #888">
                  <span class="status-badge status-{{ job.status }}"
                    >{{ job.status }}</span
                  >
                  {{ job.interactions_found }} interactions
                </div>
              </div>
              <button
                class="delete-job-btn"
                onclick="event.stopPropagation(); deleteJob({{ job.id }})"
                title="Delete job"
              >
                🗑️
              </button>
            </div>
            {% endfor %} {% else %}
            <div class="empty-state">
              <p>No jobs yet. Start your first search!</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <div
        class="progress-container"
        id="progress-container"
        style="display: none"
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2 style="margin: 0">📝 Job Progress</h2>
          <button
            id="stop-job-btn"
            class="btn"
            style="
              width: auto;
              padding: 8px 16px;
              font-size: 14px;
              background: rgba(255, 118, 117, 0.2);
              color: #ff7675;
              border: 1px solid rgba(255, 118, 117, 0.3);
            "
            onclick="stopJob()"
          >
            ⏹ Stop Job
          </button>
        </div>
        <div><strong>Variable:</strong> <span id="job-variable"></span></div>
        <div style="margin-top: 10px">
          <span id="job-status-badge" class="status-badge"></span>
        </div>
        <div style="margin-top: 10px">
          <strong>Progress:</strong>
          <span id="job-interactions">0</span> interactions from
          <span id="job-papers">0</span> papers
        </div>
        <div class="step-log" id="step-log">
          <div class="step">Waiting for updates...</div>
        </div>
      </div>

      <div class="card">
        <h2 id="interactions-heading">🔍 Discovered Interactions</h2>
        <div id="interactions-container">
          <div class="empty-state">
            <p>
              Loading interactions...
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentJobId = null;
      let pollInterval = null;
      let lastLogText = ''; // Keep previous logs to only append new lines

      // Load all workspace interactions
      async function loadAllWorkspaceInteractions() {
        try {
          const response = await fetch('/scraper/api/interactions/');
          const data = await response.json();
          // Update heading to show all workspace interactions
          document.getElementById('interactions-heading').textContent = 
            '🔍 All Workspace Interactions';
          displayInteractions(data.interactions);
        } catch (error) {
          console.error('Error loading workspace interactions:', error);
        }
      }

      // On page load, check if there's a running or recent job to display
      window.addEventListener('DOMContentLoaded', () => {
        // Check URL parameters for job_id
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('job_id');

        if (jobId) {
          loadJob(parseInt(jobId));
        } else {
          // Load all workspace interactions when no specific job is selected
          loadAllWorkspaceInteractions();
        }
      });

      // Handle form submission
      document
        .getElementById('scraper-form')
        .addEventListener('submit', async (e) => {
          e.preventDefault();

          const variable = document.getElementById('variable').value;
          const minInteractions =
            document.getElementById('min-interactions').value;
          const btn = document.getElementById('start-btn');

          btn.disabled = true;
          btn.innerHTML = '<span class="loading"></span> Starting...';

          try {
            const response = await fetch('/scraper/api/start/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                variable_of_interest: variable,
                min_interactions: parseInt(minInteractions),
              }),
            });

            const data = await response.json();

            if (response.ok) {
              currentJobId = data.job_id;

              // Redirect to show the job with query parameter
              window.location.href = `/scraper/?job_id=${data.job_id}`;
            } else {
              alert('Error: ' + data.error);
            }
          } catch (error) {
            alert('Error starting job: ' + error.message);
          } finally {
            btn.disabled = false;
            btn.innerHTML = 'Start Scraping';
          }
        });

      // Load job details
      async function loadJob(jobId) {
        currentJobId = jobId;
        document.getElementById('progress-container').style.display = 'block';
        lastLogText = ''; // reset on job switch

        try {
          const response = await fetch(`/scraper/api/job/${jobId}/status/`);
          
          // If job not found (e.g., from different workspace), redirect to clean page
          if (response.status === 404) {
            console.warn('Job not found in current workspace, redirecting...');
            window.location.href = '/scraper/';
            return;
          }
          
          const data = await response.json();

          updateJobDisplay(data);
          loadJobInteractions(jobId);

          // Always poll while a job is visible to get near-live logs,
          // even if backend status isn't strictly 'running' yet
          startPolling();
        } catch (error) {
          console.error('Error loading job:', error);
          // On error, show all workspace interactions instead
          loadAllWorkspaceInteractions();
        }
      }

      // Update job display
      function updateJobDisplay(data) {
        document.getElementById('job-variable').textContent =
          data.variable_of_interest;
        document.getElementById('job-interactions').textContent =
          data.interactions_found;
        document.getElementById('job-papers').textContent = data.papers_checked;

        const statusBadge = document.getElementById('job-status-badge');
        statusBadge.textContent = data.status;
        statusBadge.className = 'status-badge status-' + data.status;

        // Update stop button visibility
        updateStopButton(data.status);

        // Append only new logs incrementally with color coding
        if (typeof data.logs === 'string') {
          const stepLog = document.getElementById('step-log');
          let newText = data.logs;
          if (lastLogText && newText.startsWith(lastLogText)) {
            newText = newText.slice(lastLogText.length);
          } else if (!lastLogText) {
            // first render: clear placeholder
            stepLog.innerHTML = '';
          } else {
            // logs were truncated or changed; re-render entire block
            stepLog.innerHTML = '';
          }

          const newLines = newText.split('\n').filter((l) => l.trim());
          for (const line of newLines) {
            let color = '#d4d4d4';
            let style = '';
            if (line.includes('✓') || line.toLowerCase().includes('success')) {
              color = '#4ec9b0';
            } else if (
              line.includes('✗') ||
              line.toLowerCase().includes('error') ||
              line.toLowerCase().includes('failed')
            ) {
              color = '#f48771';
            } else if (
              line.includes('💾') ||
              line.includes('Found interaction')
            ) {
              color = '#dcdcaa';
              style = 'font-weight: bold;';
            } else if (line.includes('📥') || line.includes('📄')) {
              color = '#569cd6';
            } else if (line.includes('[QUERY]') || line.includes('QUERY')) {
              color = '#c586c0';
            } else if (line.includes('[PUBMED]') || line.includes('PUBMED')) {
              color = '#9cdcfe';
            } else if (
              line.includes('[ABSTRACT]') ||
              line.includes('ABSTRACT')
            ) {
              color = '#ce9178';
            }
            const div = document.createElement('div');
            div.className = 'step';
            div.style.color = color;
            if (style) div.style.cssText += style;
            div.textContent = line;
            stepLog.appendChild(div);
          }
          if (newLines.length > 0) {
            stepLog.scrollTop = stepLog.scrollHeight;
          }
          lastLogText = data.logs;
        }
      }

      // Load interactions for job
      async function loadJobInteractions(jobId) {
        try {
          const response = await fetch(
            `/scraper/api/job/${jobId}/interactions/`
          );
          const data = await response.json();

          // Update heading to show job-specific interactions
          document.getElementById('interactions-heading').textContent = 
            '🔍 Job Interactions';
          displayInteractions(data.interactions);
        } catch (error) {
          console.error('Error loading interactions:', error);
        }
      }

      // Display interactions in table
      function displayInteractions(interactions) {
        const container = document.getElementById('interactions-container');

        if (interactions.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><p>No interactions in this workspace yet. Start a scraping job to discover interactions.</p></div>';
          return;
        }

        let html = `
                 <table class="interactions-table">
                     <thead>
                         <tr>
                             <th>Independent Variable</th>
                             <th>Effect</th>
                             <th>Dependent Variable</th>
                             <th>Reference</th>
                         </tr>
                     </thead>
                     <tbody>
             `;

        interactions.forEach((i) => {
          // Convert effect to readable text
          let effectText = '';
          let effectClass = '';

          if (i.effect === '+') {
            effectText = '<strong style="color: #00b894;">INCREASES</strong>';
            effectClass = 'effect-positive';
          } else if (i.effect === '-') {
            effectText = '<strong style="color: #ff7675;">DECREASES</strong>';
            effectClass = 'effect-negative';
          } else {
            effectText = i.effect; // fallback for other values
            effectClass = '';
          }

          html += `
                     <tr>
                         <td>${i.independent_variable}</td>
                         <td class="${effectClass}">${effectText}</td>
                         <td>${i.dependent_variable}</td>
                         <td><a href="https://doi.org/${i.reference}" target="_blank" style="color: #667eea; text-decoration: none;">${i.reference}</a></td>
                     </tr>
                 `;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
      }

      // Start polling for updates
      function startPolling() {
        if (pollInterval) return;

        pollInterval = setInterval(async () => {
          if (!currentJobId) return;

          try {
            const response = await fetch(
              `/scraper/api/job/${currentJobId}/status/`
            );
            
            // If job not found (switched workspace), stop polling and redirect
            if (response.status === 404) {
              console.warn('Job no longer accessible, stopping polling');
              stopPolling();
              window.location.href = '/scraper/';
              return;
            }
            
            const data = await response.json();

            updateJobDisplay(data);
            loadJobInteractions(currentJobId);

            // Update total interactions count
            const interactionsResponse = await fetch(
              '/scraper/api/interactions/'
            );
            const interactionsData = await interactionsResponse.json();
            document.getElementById('total-interactions').textContent =
              interactionsData.total;
            // Keep polling until user navigates away; stop when job is completed and logs won't change
            if (data.status === 'completed' || data.status === 'failed') {
              // One more refresh to ensure we got final logs, then stop
              setTimeout(stopPolling, 1500);
            }
          } catch (error) {
            console.error('Polling error:', error);
          }
        }, 1000); // Poll every 1 second for snappier updates
      }

      // Stop polling
      function stopPolling() {
        if (pollInterval) {
          clearInterval(pollInterval);
          pollInterval = null;
        }
      }

      // Stop/cancel current job
      async function stopJob() {
        if (!currentJobId) return;

        if (!confirm('Are you sure you want to stop this job?')) {
          return;
        }

        try {
          const response = await fetch(
            `/scraper/api/job/${currentJobId}/stop/`,
            {
              method: 'POST',
            }
          );

          const data = await response.json();
          if (response.ok) {
            alert(data.message || 'Stop requested');
            // Keep polling to observe job shutting down gracefully
            loadJob(currentJobId);
          } else {
            alert(data.error || 'Failed to stop job');
          }
        } catch (error) {
          console.error('Error stopping job:', error);
          alert('Error stopping job');
        }
      }

      // Update stop button visibility based on status
      function updateStopButton(status) {
        const stopBtn = document.getElementById('stop-job-btn');
        if (stopBtn) {
          if (status === 'running') {
            stopBtn.style.display = 'block';
          } else {
            stopBtn.style.display = 'none';
          }
        }
      }

      // Switch workspace
      async function switchWorkspace() {
        const workspace = document.getElementById('workspace-select').value;
        
        // Stop polling before switching
        stopPolling();
        
        try {
          const response = await fetch('/scraper/api/workspace/switch/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ workspace: workspace }),
          });

          const data = await response.json();

          if (response.ok) {
            // Reload WITHOUT job_id parameter to show clean workspace
            window.location.href = '/scraper/';
          } else {
            alert('Error: ' + data.error);
          }
        } catch (error) {
          alert('Error switching workspace: ' + error.message);
        }
      }

      // Create new workspace
      async function createWorkspace() {
        const workspaceName = document.getElementById('new-workspace-name').value.trim();
        
        if (!workspaceName) {
          alert('Please enter a workspace name');
          return;
        }

        // Stop polling before switching
        stopPolling();

        try {
          const response = await fetch('/scraper/api/workspace/switch/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ workspace: workspaceName }),
          });

          const data = await response.json();

          if (response.ok) {
            // Reload WITHOUT job_id parameter to show clean workspace
            window.location.href = '/scraper/';
          } else {
            alert('Error: ' + data.error);
          }
        } catch (error) {
          alert('Error creating workspace: ' + error.message);
        }
      }

      // Delete a job
      async function deleteJob(jobId, force = false) {
        if (!force && !confirm('Are you sure you want to delete this job?')) {
          return;
        }

        try {
          const response = await fetch(`/scraper/api/job/${jobId}/delete/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ force: force }),
          });

          const data = await response.json();

          if (response.ok) {
            // If we're currently viewing this job, hide the progress container
            if (currentJobId === jobId) {
              document.getElementById('progress-container').style.display =
                'none';
              currentJobId = null;
              stopPolling();
            }

            // Reload the page to refresh the jobs list
            window.location.reload();
          } else {
            // If job is running and can be force deleted, ask user
            if (data.can_force) {
              if (
                confirm(
                  data.error + '\n\nDo you want to force delete this stuck job?'
                )
              ) {
                deleteJob(jobId, true);
              }
            } else {
              alert(data.error || 'Failed to delete job');
            }
          }
        } catch (error) {
          console.error('Error deleting job:', error);
          alert('Error deleting job');
        }
      }
    </script>
  </body>
</html>
